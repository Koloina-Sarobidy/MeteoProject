@using StationControl.Models.Crm 
@using StationControl.Models.Station
@{
    Layout = "~/Areas/SuperAdmin/Views/Shared/_LayoutSuperAdmin.cshtml";
    ViewData["Title"] = "Créer un Ticket";

    var crms = ViewBag.Crms as List<Crm> ?? new List<Crm>();
    var stations = ViewBag.Stations as List<StationControl.Models.Station.Station> ?? new List<StationControl.Models.Station.Station>();
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-1"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
}

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">
                <i class="bi bi-chat-dots me-2"></i> Créer un Ticket
            </h5>
        </div>
        <div class="card-body">
            <form id="ticketForm" method="post" enctype="multipart/form-data" 
                  action="@Url.Action("CreateTicket", "Ticket", new { area = "SuperAdmin" })">

                <!-- Objet du ticket -->
                <div class="mb-3">
                    <label for="Objet" class="form-label">Objet du ticket</label>
                    <input type="text" class="form-control" id="Objet" name="Objet" placeholder="Entrez l'objet du ticket" required />
                </div>

                <!-- Message -->
                <div class="mb-3">
                    <label for="Description" class="form-label">Message</label>
                    <textarea class="form-control" id="Description" name="Description" rows="4" placeholder="Écrivez votre message..." required></textarea>
                </div>

                <!-- Pièces jointes -->
                <div class="mb-3" id="attachmentsContainer">
                    <label class="form-label">Pièces jointes</label>
                    <input type="file" class="form-control mb-2" name="Attachments" />
                </div>

                <button type="button" class="btn btn-primary mb-3" id="addAttachmentBtn">
                    <i class="bi bi-plus-circle"></i> Ajouter une pièce jointe
                </button>

                <!-- Sélection CRM -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Destinataires CRM</label>
                    <div class="row">
                        @foreach (var crm in crms)
                        {
                            <div class="col-12 col-sm-6 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="CrmIds" value="@crm.Id" id="crm_@crm.Id">
                                    <label class="form-check-label" for="crm_@crm.Id">@crm.Libelle</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Sélection Stations -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Destinataires Station</label>
                    <div class="row">
                        @foreach (var station in stations)
                        {
                            <div class="col-12 col-sm-6 col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="StationIds" value="@station.Id" id="station_@station.Id">
                                    <label class="form-check-label" for="station_@station.Id">@station.Nom</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="text-end">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="history.back()">
                        <i class="bi bi-arrow-left"></i> Retour
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
                        <i class="bi bi-send"></i> Envoyer le ticket
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary" id="confirmModalLabel"><i class="bi bi-exclamation-triangle"></i> Confirmation d'envoi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Voulez-vous vraiment envoyer ce ticket ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" id="confirmSendBtn">
                    <i class="bi bi-check-circle"></i> Confirmer
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('confirmSendBtn').addEventListener('click', function() {
        document.getElementById('ticketForm').submit();
    });

    document.getElementById('addAttachmentBtn').addEventListener('click', function() {
        const container = document.getElementById('attachmentsContainer');
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'Attachments';
        input.className = 'form-control mb-2';
        container.appendChild(input);
    });
</script>
}
