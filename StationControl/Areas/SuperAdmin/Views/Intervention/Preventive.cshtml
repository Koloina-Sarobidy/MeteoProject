@using StationControl.Models.Station
@using StationControl.Models.Intervention
@using StationControl.Models.Auth
@model PreventiveViewModel

@{
    Layout = "~/Areas/SuperAdmin/Views/Shared/_LayoutSuperAdmin.cshtml";
    ViewData["Title"] = "Interventions Préventives";
}

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">
                <i class="bi bi-tools me-2"></i> Interventions Préventives
            </h5>
            <button type="button" class="btn btn-outline-secondary me-2" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>

        <div class="card-body">
            <!-- Formulaire de filtre -->
            <form method="get" class="row g-3 mb-4 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Nom de la station</label>
                    <input type="text" name="StationNom" value="@Model.Filtre.StationNom" class="form-control" placeholder="Ex: Station Antananarivo"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date prévue début</label>
                    <input type="date" name="DatePrevueDebut" value="@Model.Filtre.DatePrevueDebut?.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date effective début</label>
                    <input type="date" name="DateEffectiveDebut" value="@Model.Filtre.DateEffectiveDebut?.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Observateur planificateur</label>
                    <select name="PlanificateurId" class="form-select">
                        <option value="">-- Tous --</option>
                        @foreach (var plan in Model.Planificateurs)
                        {
                            <option value="@plan.Id" @(plan.Id == Model.Filtre.PlanificateurId ? "selected" : "")>@plan.Nom</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Observateur effectif</label>
                    <select name="EffectifId" class="form-select">
                        <option value="">-- Tous --</option>
                        @foreach (var eff in Model.Effectifs)
                        {
                            <option value="@eff.Id" @(eff.Id == Model.Filtre.EffectifId ? "selected" : "")>@eff.Nom</option>
                        }
                    </select>
                </div>
                <div class="col-md-4 d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-funnel me-1"></i> Filtrer
                    </button>
                    <a href="@Url.Action("Preventive", "Intervention", new { area = "SuperAdmin" })" class="btn btn-outline-secondary flex-grow-1">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Réinitialiser
                    </a>
                </div>

            </form>

            <br/><br/>

            <!-- Table des interventions -->
            <div class="table-responsive" style="max-height: 450px; overflow-y: auto; overflow-x: auto;">
                <table class="table table-striped table-bordered align-middle mb-0">
                    <thead class="table-light" style="position: sticky; top: 0; z-index: 5;">
                        <tr>
                            <th style="min-width: 100px; white-space: nowrap;">Nom de la Station</th>
                            <th style="min-width: 250px;">Description</th>
                            <th style="min-width: 100px;">Statut</th>
                            <th style="min-width: 220px; white-space: nowrap;">Date prévue</th>
                            <th style="min-width: 220px; white-space: nowrap;">Date effective</th>
                            <th style="min-width: 220px; white-space: nowrap;">Observateur planificateur</th>
                            <th style="min-width: 220px; white-space: nowrap;">Observateur effectif</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Interventions != null && Model.Interventions.Any())
                        {
                            int index = 1 + (Model.Page - 1) * Model.PageSize;
                            foreach (var preventive in Model.Interventions)
                            {
                                <tr>
                                    <td>@preventive.Station?.Nom</td>
                                    <td>@preventive.Description</td>
                                    <td>
                                        @if (preventive.EstComplete == true)
                                        {
                                            <span class="badge bg-success">Terminée</span>
                                        }
                                        else if (preventive.EstAnnule == true)
                                        {
                                            <span class="badge bg-danger">Annulée</span>
                                        }
                                        else if (preventive.EstComplete != true && preventive.DateEffectiveDebut == null)
                                        {
                                            <span class="badge bg-secondary">Planifiée</span>
                                        }
                                        else if (preventive.EstComplete != true && preventive.DateEffectiveDebut != null)
                                        {
                                            <span class="badge bg-warning">En cours</span>
                                        }
                                    </td>
                                    <td>
                                        @preventive.DatePrevueDebut.ToString("dd/MM/yyyy")
                                        @if (preventive.DatePrevueFin.HasValue)
                                        {
                                            <text> <strong>au</strong> @preventive.DatePrevueFin.Value.ToString("dd/MM/yyyy")</text>
                                        }
                                    </td>

                                    <td>
                                        @(preventive.DateEffectiveDebut?.ToString("dd/MM/yyyy"))
                                        @if (preventive.DateEffectiveFin.HasValue)
                                        {
                                            <text> <strong>au</strong>  @preventive.DateEffectiveFin.Value.ToString("dd/MM/yyyy")</text>
                                        }
                                    </td>

                                    <td>@preventive.UtilisateurPlanificateur?.Nom @preventive.UtilisateurPlanificateur?.Prenom</td>
                                    <td>@preventive.UtilisateurEffectif?.Nom @preventive.UtilisateurEffectif?.Prenom</td>
                                </tr>
                                index++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">Aucune intervention trouvée.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>


            <!-- Pagination -->
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mt-3">
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.Page ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Preventive", new { 
                                page = i, 
                                StationNom = Model.Filtre.StationNom, 
                                DatePrevueDebut = Model.Filtre.DatePrevueDebut?.ToString("yyyy-MM-dd"),
                                DateEffectiveDebut = Model.Filtre.DateEffectiveDebut?.ToString("yyyy-MM-dd"),
                                PlanificateurId = Model.Filtre.PlanificateurId,
                                EffectifId = Model.Filtre.EffectifId 
                            })">
                                @i
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    </div>
</div>
