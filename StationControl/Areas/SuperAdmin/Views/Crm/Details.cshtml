@model StationControl.Models.Crm.Crm
@{
    Layout = "~/Areas/SuperAdmin/Views/Shared/_LayoutSuperAdmin.cshtml";
    ViewData["Title"] = "Détails CRM";
}

<!-- Affichage des messages TempData -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-1"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
}

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="bi bi-info-circle"></i> Détails du CRM</h5>
            <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>

        @if (Model.EstArrete == true)
        {
        <div class="card-body">
            <form id="crmForm" method="post" action="@Url.Action("Modifier", "Crm", new { area = "SuperAdmin", id = Model.Id })">
                <div class="mb-3">
                    <label class="form-label">Nom du CRM (arrêté)</label>
                    <input type="text" name="libelle" class="form-control" value="@Model.Libelle" required>
                </div>                
            </form>
        </div>
        }
        else 
        {
            <div class="card-body">
            <form id="crmForm" method="post" action="@Url.Action("Modifier", "Crm", new { area = "SuperAdmin", id = Model.Id })">
                <div class="mb-3">
                    <label class="form-label">Nom du CRM (modifiable)</label>
                    <input type="text" name="libelle" class="form-control" value="@Model.Libelle" required>
                </div>                
                  <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#confirmModal">
                            <i class="bi bi-save"></i> Enregistrer
                        </button>

                        <button type="button" class="btn btn-outline-danger" id="arreterCrmBtn">
                            <i class="bi bi-exclamation-triangle"></i> Arrêter
                        </button>
                    </div>
                
            </form>
        </div>

        }
                  
    </div>
</div>

<!-- === Modal de confirmation Enregistrer === -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary" id="confirmModalLabel"><i class="bi bi-exclamation-triangle"></i> Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Voulez-vous vraiment enregistrer les modifications apportées à ce CRM ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" id="confirmSubmit">
                    <i class="bi bi-check-circle"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- === Modal confirmation Arrêter CRM === -->
<div class="modal fade" id="arreterCrmModal" tabindex="-1" aria-labelledby="arreterCrmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-danger" id="arreterCrmModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmation d'arrêt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fw-semibold text-secondary">
                    Voulez-vous vraiment arrêter ce CRM ?<br/>
                    Cette action est irréversible.
                </p>
                <p class="fw-semibold text-secondary mt-3">
                    Tapez <strong>1</strong> pour confirmer :
                </p>
                <input type="text" id="confirmationInputCrm" class="form-control text-center fw-bold fs-5" placeholder="Tapez 1">
                <div id="inputErrorCrm" class="text-danger mt-2 fw-semibold d-none">
                    Vous devez taper 1 pour confirmer l'arrêt !
                </div>
            </div>
            <div class="modal-footer justify-content-center border-0 pb-4">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
                <form method="post" action="@Url.Action("Arreter", "Crm", new { area = "SuperAdmin", id = Model.Id })" id="arreterForm">
                    <input type="hidden" name="confirmation" id="hiddenConfirmationCrm" />
                    <button type="submit" class="btn btn-danger px-4" id="confirmArreterCrmBtn">
                        <i class="bi bi-check-circle"></i> Confirmer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // === Enregistrer ===
    document.getElementById("confirmSubmit").addEventListener("click", function () {
        document.getElementById("crmForm").submit();
    });

    // === Arrêter CRM ===
    const arreterBtn = document.getElementById('arreterCrmBtn');
    const input = document.getElementById('confirmationInputCrm');
    const inputError = document.getElementById('inputErrorCrm');
    const confirmBtn = document.getElementById('confirmArreterCrmBtn');
    const hiddenInput = document.getElementById('hiddenConfirmationCrm');

    if (arreterBtn) {
        arreterBtn.addEventListener('click', function () {
            input.value = '';
            inputError.classList.add('d-none');
            input.classList.remove('is-invalid');
            new bootstrap.Modal(document.getElementById('arreterCrmModal')).show();
        });
    }

    input.addEventListener('input', function() {
        if (input.value.trim() === "1") {
            inputError.classList.add('d-none');
            input.classList.remove('is-invalid');
        } else {
            inputError.classList.remove('d-none');
            input.classList.add('is-invalid');
        }
    });

    confirmBtn.addEventListener('click', function(e) {
        if (input.value.trim() !== "1") {
            e.preventDefault();
            inputError.classList.remove('d-none');
            input.classList.add('is-invalid');
            return false;
        }
        hiddenInput.value = input.value.trim();
    });
</script>
}
