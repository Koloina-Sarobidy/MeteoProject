@model StationControl.Models.Auth.Utilisateur

@{
    Layout = "~/Areas/Observateur/Views/Shared/_LayoutObservateur.cshtml";
    ViewData["Title"] = "Détails de l'Observateur";
}

<div class="container-fluid py-4">
    <div class="card shadow-sm border-0">

        <!-- Header -->
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">
                <i class="bi bi-person-badge me-2"></i> Détails de l'Observateur
            </h5>
            <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>

        <div class="card-body">
            <div class="row">
                <!-- PHOTO + NOM -->
                <div class="col-xl-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-body pt-4 d-flex flex-column align-items-center">
                            <img src="@(!string.IsNullOrEmpty(Model.PhotoProfil) 
                                    ? Url.Content($"~/uploads/profiles/{Model.PhotoProfil}") 
                                    : $"https://ui-avatars.com/api/?name={Model.Prenom}+{Model.Nom}&background=008B8B&color=fff")"
                                 class="rounded-circle mb-3"
                                 style="width:150px; height:150px; object-fit:cover; border:2px solid #ddd;" />
                            <h4>@Model.Nom @Model.Prenom</h4>
                            <h5 class="text-muted">@Model.Role?.Libelle</h5>
                        </div>
                    </div>
                </div>

                <!-- INFOS -->
                <div class="col-xl-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-body pt-3">
                            <h5 class="card-title text-primary">
                                <i class="bi bi-info-circle me-2"></i> Informations personnelles
                            </h5>

                            <!-- Informations principales -->
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Nom :</div>
                                <div class="col-md-8">@Model.Nom</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Prénom :</div>
                                <div class="col-md-8">@Model.Prenom</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Email :</div>
                                <div class="col-md-8">@Model.Email</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Genre :</div>
                                <div class="col-md-8">@Model.Genre</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Statut :</div>
                                <div class="col-md-8">
                                    @if (Model.Statut == "Actif")
                                    {
                                        <span class="badge bg-success">Actif</span>
                                    }
                                    else if (Model.Statut == "Congé")
                                    {
                                        <span class="badge bg-warning">@Model.Statut</span> 
                                        <div class="small text-muted">
                                            Du : @Model.DateDebut.ToString("dd/MM/yyyy") au @Model.DateFin?.ToString("dd/MM/yyyy")
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@Model.Statut</span>
                                    }
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Date d'entrée :</div>
                                <div class="col-md-8">@Model.DateDebut.ToString("dd/MM/yyyy")</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 fw-semibold">Station :</div>
                                <div class="col-md-8">@ViewBag.Station.Nom</div>
                            </div>
                            @if (Model.DateFin != null)
                            {
                                <div class="row mb-3">
                                    <div class="col-md-4 fw-semibold">Date fin :</div>
                                    <div class="col-md-8">@Model.DateFin?.ToString("dd/MM/yyyy")</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div> <!-- row -->

            <!-- FORMULAIRE MODIFICATION STATUT -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="bi bi-person-gear me-2"></i> Modifier le statut</h5>
                </div>
                <div class="card-body">

                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle me-1"></i>
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                        </div>
                    }

                    <form id="statutForm" method="post" action="@Url.Action("ModifierStatut", "Personnel", new { area = "Observateur" })">
                        <input type="hidden" name="utilisateurId" value="@Model.Id" />
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Statut actuel</label><br />
                            @if (Model.Statut == "Actif")
                            {
                                <span class="badge bg-success">@Model.Statut</span>
                            }
                            else if (Model.Statut == "Congé")
                            {
                                <span class="badge bg-warning">@Model.Statut</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">@Model.Statut</span>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Nouveau statut</label>
                            <select class="form-select" name="statut" id="statutSelect" required>
                                <option value="">-- Sélectionner --</option>
                                <option value="Actif">Actif</option>
                                <option value="Congé">Congé</option>
                                <option value="Retraité">Retraité</option>
                                <option value="Affecté">Affecté</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Date de début</label>
                            <input type="date" class="form-control" name="dateDebut" required />
                        </div>

                        <div class="mb-3 d-none" id="dateFinContainer">
                            <label class="form-label fw-bold">Date de fin</label>
                            <input type="date" class="form-control" name="dateFin" />
                        </div>


                        <div class="mb-3">
                            <label class="form-label fw-bold">Description</label>
                            <textarea name="description" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="history.back()">
                                <i class="bi bi-arrow-left"></i> Retour
                            </button>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
                                <i class="bi bi-check-circle me-1"></i> Valider
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div> <!-- card-body -->
    </div> <!-- card -->
</div> <!-- container -->

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary"><i class="bi bi-exclamation-triangle"></i> Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Voulez-vous vraiment modifier le statut ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" id="confirmSubmit">
                    <i class="bi bi-check-circle"></i> Confirmer
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById("statutSelect").addEventListener("change", function () {
        const dateFin = document.getElementById("dateFinContainer");
        if (this.value === "Congé") {
            dateFin.classList.remove("d-none");
        } else {
            dateFin.classList.add("d-none");
        }
    });

    document.getElementById("confirmSubmit").addEventListener("click", function () {
        document.getElementById("statutForm").submit();
    });
</script>
}
