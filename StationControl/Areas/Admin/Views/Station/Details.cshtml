@using StationControl.Models.Station
@{
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Détails Station";

    var station = ViewBag.Station as Station;
    var capteursStation = ViewBag.CapteursStation as List<CapteurStation> ?? new List<CapteurStation>();
    var alimentationsStation = ViewBag.AlimentationsStation as List<AlimentationStation> ?? new List<AlimentationStation>();
}

<div class="container-fluid py-4">

    <!-- Bloc principal : Carte + Infos -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">
                <i class="bi bi-geo-alt"></i> @station.Nom
            </h5>
            <button class="btn btn-outline-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>

        <div class="card-body">
            <div class="row g-4">
                <!-- Carte -->
                <div class="col-md-8">
                    <div id="map"></div>
                </div>

                <!-- Informations -->
                <div class="col-md-4">
                    <h6 class="fw-semibold mb-3 text-secondary">Informations de la station</h6>
                    <ul class="list-group list-group-flush small">
                        <li class="list-group-item"><b>Nom :</b> @station.Nom</li>
                        <li class="list-group-item"><b>Région :</b> @station.Region?.Libelle</li>
                        <li class="list-group-item"><b>Crm :</b> @station.Crm?.Libelle</li>
                        <li class="list-group-item"><b>Latitude :</b> @station.Latitude</li>
                        <li class="list-group-item"><b>Longitude :</b> @station.Longitude</li>
                        <li class="list-group-item">
                            <b>Etat:</b> 
                            @if (station.Statut == "Fonctionnelle")
                            {
                                 <span class="badge bg-success">@station.Statut</span>  
                            }
                            else if (station.Statut == "Partiellement Fonctionnelle")
                            {
                                 <span class="badge bg-warning">@station.Statut</span>  
                            }
                            else if (station.Statut == "Non Fonctionnelle")
                            {
                                 <span class="badge bg-danger">@station.Statut</span>  
                            }
                        <li class="list-group-item">
                            <b>Statut :</b>
                            @if (station.EstArrete == true)
                            {
                                <span class="badge bg-danger">Arrêtée</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Active</span>
                            }
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des Capteurs -->
    @if (capteursStation.Count > 0)
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-cpu"></i> Capteurs de la station
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Numéro de série</th>
                            <th>Type de capteur</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var capteurStation in capteursStation)
                        {
                            <tr>
                                <td>@capteurStation.Id</td>
                                <td>@capteurStation.NumSerie</td>
                                <td>@capteurStation.Capteur?.Libelle</td>
                                <td>
                                    @if (capteurStation.Statut?.ToLower() == "fonctionnel")
                                    {
                                        <span class="badge bg-success">Fonctionnel</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">@capteurStation.Statut</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- Liste des Alimentations -->
    @if (alimentationsStation.Count > 0)
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-primary">
                    <i class="bi bi-lightning-charge"></i> Alimentations de la station
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Numéro de série</th>
                            <th>Type d’alimentation</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var alimStation in alimentationsStation)
                        {
                            <tr>
                                <td>@alimStation.Id</td>
                                <td>@alimStation.NumSerie</td>
                                <td>@alimStation.Alimentation?.Libelle</td>
                                <td>
                                    @if (alimStation.Statut?.ToLower() == "fonctionnel")
                                    {
                                        <span class="badge bg-success">Fonctionnelle</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">@alimStation.Statut</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

</div>
@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var lat = parseFloat('@(station.Latitude?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "0")');
            var lng = parseFloat('@(station.Longitude?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "0")');
            var statut = '@(station.Statut ?? "")';
            var color;

            if (statut === "Fonctionnelle") {
                color = "green"; 
            } else if (statut === "Partiellement Fonctionnelle") {
                color = "orange"; 
            } else if (statut === "Non Fonctionnelle") {
                color = "red"; 
            } else {
                color = "gray"; 
            }

            var map = L.map('map').setView([lat, lng], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            var marker = L.circleMarker([lat, lng], {
                color: color,
                fillColor: color,
                radius: 10,
                fillOpacity: 0.6
            }).addTo(map);

            marker.bindPopup(
                `<b>@station.Nom</b><br/>
                 Latitude: @station.Latitude<br/>
                 Longitude: @station.Longitude<br/>
                 Région: @station.Region?.Libelle<br/>
                 Statut: @station.Statut`
            );
        });
    </script>

    <style>
        #map { border-radius: 12px; height: 650px; width: 100%; }
        .list-group-item .badge { font-size: 0.85rem; padding: 0.35em 0.6em; }
    </style>
}

