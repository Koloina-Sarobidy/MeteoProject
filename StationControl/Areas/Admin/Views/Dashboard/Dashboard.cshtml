@using StationControl.Models.Station
@using StationControl.Models.Intervention
@{
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Dashboard";

    var stations = ViewBag.Stations as List<Station> ?? new List<Station>();
    var crmChartData = ViewBag.CrmChartData;
    var interventions = ViewBag.Interventions as List<Intervention> ?? new List<Intervention>();

    var selectedStationId = ViewBag.SelectedStationId as int?;
    var selectedStatut = ViewBag.SelectedStatut as string;
    var selectedMois = ViewBag.SelectedMois as int? ?? DateTime.Now.Month;
    var selectedAnnee = ViewBag.SelectedAnnee as int? ?? DateTime.Now.Year;
}

<div class="container-fluid py-4">

    <!-- CARTE DES STATIONS -->
    <div class="card shadow-sm border-0 mb-4 bg-white">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="bi bi-geo-alt"></i> Carte des stations</h5>
        </div>
        <div class="card-body">
            <div id="map" style="height:600px; width:100%; border-radius:12px;"></div>
        </div>
    </div>

    <!-- PIE CHARTS PAR CRM -->
    <div class="card shadow-sm border-0 mb-4 bg-white p-3">
        <div class="card-header bg-white">
            <h5 class="mb-0 text-primary"><i class="bi bi-pie-chart"></i> Statuts des stations par CRM</h5>
        </div>
        <div class="row" id="crmChartsContainer">
            @if (crmChartData.Count == 0)
            {
                <div class="col-12 text-center text-muted py-4">Aucun CRM trouvé...</div>
            }
            else
            {
                foreach (var crm in crmChartData)
                {
                    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                        <div class="card shadow-sm border-0 h-100 bg-white">
                            <div class="card-header bg-white">
                                <h6 class="mb-0 fw-semibold text-primary"><i class="bi bi-building"></i> @crm.CrmName</h6>
                            </div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <canvas id="pieChart-@crm.CrmId" style="max-width:100%; height:280px;"></canvas>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- INTERVENTIONS DES STATIONS -->
    <div class="card shadow-sm border-0 mb-4 bg-white p-3">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="bi bi-list-check"></i> Interventions des stations</h5>
        </div>

        <!-- FILTRE -->
        <form method="get" class="row g-3 mb-3">
            <div class="col-md-4">
                <label class="form-label">Station</label>
                <select name="stationId" class="form-select">
                    <option value="">-- Toutes --</option>
                    @foreach (var s in stations)
                    {
                        <option value="@s.Id" @(selectedStationId == s.Id ? "selected" : "")>@s.Nom</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Statut / Type</label>
                <select name="statut" class="form-select">
                    <option value="">-- Tous --</option>
                    <option value="Planifiée" @(selectedStatut == "Planifiée" ? "selected" : "")>Planifiée</option>
                    <option value="En cours" @(selectedStatut == "En cours" ? "selected" : "")>En cours</option>
                    <option value="Terminée" @(selectedStatut == "Terminée" ? "selected" : "")>Terminée</option>
                    <option value="Annulée" @(selectedStatut == "Annulée" ? "selected" : "")>Annulée</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Mois</label>
                <input type="number" name="mois" class="form-control" min="1" max="12" value="@selectedMois" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Année</label>
                <input type="number" name="annee" class="form-control" min="2020" max="2100" value="@selectedAnnee" />
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary mt-2"><i class="bi bi-funnel"></i> Filtrer</button>
            </div>
        </form>

        <!-- TABLEAU DES INTERVENTIONS -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle" id="interventionsTable">
                <thead class="table-light">
                    <tr>
                        <th>Station</th>
                        <th>Date Planifiée</th>
                        <th>Date Effective</th>
                        <th>Technicien Planifié</th>
                        <th>Technicien Effectif</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!interventions.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">Aucune intervention trouvée pour ces critères.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var i in interventions)
                        {
                            var stationName = stations.FirstOrDefault(s => s.Id == i.StationId)?.Nom ?? "-";
                            <tr>
                                <td>@stationName</td>
                                <td>@i.DatePlanifieeDebut.ToString("dd/MM/yyyy")</td>
                                <td>@(i.DateEffectiveDebut?.ToString("dd/MM/yyyy") ?? "-")</td>
                                <td>@i.TechnicienPlanifie</td>
                                <td>@i.TechnicienEffectif</td>
                                <td>@i.Statut</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="~/vendor/chart.js/chart.umd.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    var map = L.map('map').setView([-18.8792, 47.5079], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var pieCharts = {};

    function updateDashboard() {
        var stationId = document.querySelector("select[name='stationId']").value;
        var statut = document.querySelector("select[name='statut']").value;
        var mois = document.querySelector("input[name='mois']").value;
        var annee = document.querySelector("input[name='annee']").value;

        var url = '@Url.Action("RealtimeDataAdmin","Dashboard", new { area="Admin" })' +
                  `?stationId=${stationId}&statut=${statut}&mois=${mois}&annee=${annee}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                // Carte
                map.eachLayer(layer => { if(layer instanceof L.CircleMarker) map.removeLayer(layer); });
                data.Stations.forEach(s => {
                    var color = "gray";
                    var statutLower = (s.Statut || "").toLowerCase();
                    if(statutLower === "fonctionnelle") color = "green";
                    else if(statutLower === "partiellement fonctionnelle") color = "orange";
                    else if(statutLower === "non fonctionnelle") color = "red";

                    var popupContent = `
                        <b>${s.Nom}</b><br/>
                        <b>Statut :</b> ${s.Statut}<br/>
                        <b>Latitude :</b> ${s.Latitude}<br/>
                        <b>Longitude :</b> ${s.Longitude}<br/>
                        <b>Type :</b> ${s.TypeStation?.Libelle ?? "-"}<br/>
                        <b>Region :</b> ${s.Region?.Libelle ?? "-"}<br/>
                        <b>Importance :</b> ${s.Importance?.Libelle ?? "-"}<br/>
                        <b>Début :</b> ${s.DateDebut}<br/>
                    `;
                    L.circleMarker([parseFloat(s.Latitude), parseFloat(s.Longitude)], {
                        color: color, radius: 8, fillOpacity: 0.8
                    }).addTo(map).bindPopup(popupContent);
                });

                // Pie charts
                data.CrmChartData.forEach(crm => {
                    var ctx = document.getElementById("pieChart-" + crm.CrmId);
                    if(!ctx) return;

                    var chartData = [
                        crm.Percentages["Fonctionnelle"] ?? 0,
                        crm.Percentages["Partiellement Fonctionnelle"] ?? 0,
                        crm.Percentages["Non Fonctionnelle"] ?? 0
                    ];

                    if(pieCharts[crm.CrmId]){
                        pieCharts[crm.CrmId].data.datasets[0].data = chartData;
                        pieCharts[crm.CrmId].update();
                    } else {
                        pieCharts[crm.CrmId] = new Chart(ctx.getContext('2d'), {
                            type: 'pie',
                            data: {
                                labels: ["Fonctionnelle","Partiellement Fonctionnelle","Non Fonctionnelle"],
                                datasets: [{ data: chartData, backgroundColor: ["#28a745","#fd7e14","#dc3545"], borderWidth: 1 } ]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
                        });
                    }
                });

                // Tableau interventions
                var tbody = document.querySelector("#interventionsTable tbody");
                tbody.innerHTML = "";
                if(data.Interventions.length === 0){
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Aucune intervention trouvée</td></tr>`;
                } else {
                    data.Interventions.forEach(i => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${i.StationName ?? "-"}</td>
                                <td>${new Date(i.DatePlanifieeDebut).toLocaleDateString()}</td>
                                <td>${i.DateEffectiveDebut ? new Date(i.DateEffectiveDebut).toLocaleDateString() : "-"}</td>
                                <td>${i.TechnicienPlanifie ?? "-"}</td>
                                <td>${i.TechnicienEffectif ?? "-"}</td>
                                <td>${i.Statut ?? "-"}</td>
                            </tr>
                        `;
                    });
                }
            })
            .catch(err => console.error("Erreur RealtimeDataAdmin:", err));
    }

    updateDashboard();
    setInterval(updateDashboard, 30000);
});
</script>
}

<style>
#map { width: 100%; height: 600px; border-radius: 12px; }
.card.bg-white { background-color: #ffffff !important; }
</style>
